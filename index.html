<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Where to publish?</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="alternate icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden; /* Prevent horizontal scrolling */
            width: 100%;
            box-sizing: border-box;
        }
        .container {
            width: 95%;
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 15px;
                border-radius: 0;
                box-sizing: border-box;
            }
        }

        @media (max-width: 480px) {
            .container {
                width: 100%;
                padding: 10px;
                margin: 0;
            }
        }

        @media (max-width: 320px) {
            .container {
                padding: 5px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .container > p {
                font-size: 0.95rem;
            }
        }
        h1 {
            font-family: 'Source Sans Pro', sans-serif;
            color: #1a365d;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
            letter-spacing: -0.5px;
            font-size: 2.2rem;
            position: relative;
            padding-bottom: 15px;
        }

        h1:after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, #3182ce, #63b3ed);
            border-radius: 3px;
        }

        .container > p {
            text-align: center;
            max-width: 800px;
            margin: 0 auto 30px;
            color: #4a5568;
            font-size: 1.05rem;
            line-height: 1.7;
        }
        table.dataTable {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            margin: 25px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            table-layout: auto;
        }

        /* Responsive table container */
        .dataTables_wrapper {
            width: 100%;
            overflow-x: auto;
            max-width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .dataTables_wrapper {
                padding-right: 5px; /* Add some padding on the right side */
            }
        }
        table.dataTable th, table.dataTable td {
            white-space: normal;
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            word-wrap: break-word;
            word-break: break-word;
            max-width: 300px;
        }

        @media (max-width: 1200px) {
            table.dataTable th, table.dataTable td {
                max-width: 200px;
            }
        }

        @media (max-width: 768px) {
            table.dataTable th, table.dataTable td {
                max-width: 150px;
                padding: 8px 10px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            table.dataTable th, table.dataTable td {
                max-width: 120px;
                padding: 6px 8px;
                font-size: 0.85rem;
            }

            /* Ensure the table doesn't overflow the container */
            table.dataTable {
                width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
        }
        table.dataTable th {
            background-color: #2c5282;
            color: white;
            position: relative;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        table.dataTable th select {
            width: 100%;
            padding: 4px;
            margin-top: 5px;
            box-sizing: border-box;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #cbd5e0;
        }
        table.dataTable tr:nth-child(even) {
            background-color: #f8fafc;
        }
        table.dataTable tr:hover {
            background-color: #ebf4ff;
            transition: background-color 0.2s ease;
        }
        /* Row coloring based on status */
        table.dataTable tr.for-profit-row {
            background-color: #ffebee; /* Light red */
        }
        table.dataTable tr.non-profit-row {
            background-color: #e8f5e9; /* Light green */
        }
        table.dataTable tr.university-press-row {
            background-color: #fffde7; /* Light yellow */
        }
        /* Ensure hover effect still works with colored rows */
        table.dataTable tr.for-profit-row:hover,
        table.dataTable tr.non-profit-row:hover,
        table.dataTable tr.university-press-row:hover {
            background-color: #ebf4ff;
        }
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 20px;
            width: auto;
            float: right;
            box-sizing: border-box;
            text-align: right;
        }
        .dataTables_wrapper .dataTables_filter input {
            padding: 8px 12px 8px 35px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-family: 'Roboto', sans-serif;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            max-width: 100%;
            box-sizing: border-box;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23718096" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
            background-repeat: no-repeat;
            background-position: 10px center;
            background-size: 16px 16px;
        }

        .dataTables_wrapper .dataTables_filter input::placeholder {
            color: #a0aec0;
        }

        @media (max-width: 768px) {
            .dataTables_wrapper .dataTables_filter {
                text-align: left;
                margin-bottom: 15px;
                padding-right: 5px;
                float: none;
                width: 100%;
            }

            .dataTables_wrapper .dataTables_filter input {
                width: 100%;
                max-width: 300px;
            }

            .dataTables_wrapper .dataTables_info {
                float: none;
                width: 100%;
                margin-bottom: 10px;
            }
        }

        @media (max-width: 480px) {
            .dataTables_wrapper .dataTables_filter {
                text-align: center;
            }

            .dataTables_wrapper .dataTables_filter input {
                width: 100%;
                max-width: 100%;
                padding: 6px 10px;
                font-size: 0.9rem;
            }
        }
        .dataTables_wrapper .dataTables_filter input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }
        .dataTables_wrapper .dataTables_length select {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-family: 'Roboto', sans-serif;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .dataTables_wrapper .dataTables_info {
            margin-bottom: 20px;
            color: #718096;
            font-size: 0.9rem;
            width: auto;
            float: left;
            box-sizing: border-box;
            padding-right: 5px;
            line-height: 32px; /* Match the height of the search input */
        }
        .dataTables_wrapper .dataTables_paginate {
            margin-top: 20px;
            width: 100%;
            box-sizing: border-box;
            padding-right: 5px;
            text-align: right;
        }

        @media (max-width: 480px) {
            .dataTables_wrapper .dataTables_info,
            .dataTables_wrapper .dataTables_paginate {
                width: 100%;
                text-align: center;
                float: none;
                padding: 0 5px;
                font-size: 0.85rem;
            }
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 8px 14px;
            border: 1px solid #e2e8f0;
            margin: 0 3px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #4a5568 !important;
            display: inline-block;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .dataTables_wrapper .dataTables_paginate .paginate_button {
                padding: 6px 10px;
                margin: 0 2px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .dataTables_wrapper .dataTables_paginate .paginate_button {
                padding: 4px 8px;
                margin: 0 1px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 320px) {
            .dataTables_wrapper .dataTables_paginate .paginate_button {
                padding: 3px 6px;
                margin: 0;
                font-size: 0.8rem;
                border-radius: 4px;
            }

            /* Hide some pagination buttons on very small screens */
            .dataTables_wrapper .dataTables_paginate .paginate_button:not(.previous):not(.next):not(.current) {
                display: none;
            }
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: #ebf8ff;
            border-color: #bee3f8;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background-color: #3182ce;
            color: white !important;
            border: 1px solid #3182ce;
            font-weight: 500;
        }

        /* Add clearfix to ensure proper layout with floated elements */
        .dataTables_wrapper:after {
            content: "";
            display: table;
            clear: both;
        }

        /* Domain details styles */
        .domain-details {
            padding: 20px;
            background-color: #f8fafc;
            margin: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            border: 1px solid #e2e8f0;
        }

        .domain-details h4 {
            margin-top: 0;
            color: #2d3748;
            font-family: 'Source Sans Pro', sans-serif;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .domain-details ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }

        .domain-details li {
            padding: 8px 12px;
            border-radius: 6px;
            background-color: white;
            border: 1px solid #edf2f7;
            transition: all 0.2s ease;
        }

        .domain-details li:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }

        .domain-name {
            font-weight: 500;
            color: #4a5568;
            display: inline-block;
            margin-right: 5px;
        }

        .domain-yes {
            color: #38a169;
            font-weight: 500;
        }

        .domain-no {
            color: #e53e3e;
            font-weight: 500;
        }

        /* Style for the expandable row control */
        td.details-control {
            position: relative;
            cursor: pointer;
        }

        td.details-control:before {
            content: '+';
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: #3182ce;
            font-weight: bold;
            margin-right: 8px;
            width: 18px;
            height: 18px;
            text-align: center;
            border: 1px solid #3182ce;
            border-radius: 50%;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        tr.shown td.details-control:before {
            content: '-';
            color: white;
            background-color: #3182ce;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        /* Styles for domain filter buttons */
        .domain-filters-container {
            margin-bottom: 20px;
            text-align: center;
        }
        .domain-filter-button {
            margin: 0 3px 4px 0;
            padding: 4px 8px;
            border: 1px solid #e2e8f0;
            background-color: #f8fafc;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .domain-filter-button:hover {
            background-color: #ebf8ff;
            border-color: #bee3f8;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
        .domain-filter-button.active {
            background-color: #3182ce;
            color: white;
            border-color: #2b6cb0;
            box-shadow: 0 2px 5px rgba(49, 130, 206, 0.2);
        }

        /* Data source filter buttons styles */
        .data-source-button {
            margin: 0 6px 8px 0;
            padding: 10px 16px;
            border: 1px solid #e2e8f0;
            background-color: #f8fafc;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .data-source-button:hover {
            background-color: #ebf8ff;
            border-color: #bee3f8;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
        .data-source-button.active {
            background-color: #3182ce;
            color: white;
            border-color: #2b6cb0;
            box-shadow: 0 2px 5px rgba(49, 130, 206, 0.2);
        }

        /* Profit status filter buttons styles */
        .profit-status-button {
            margin: 0 0 6px 0;
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: block;
            width: 100%;
            text-align: center;
        }
        .profit-status-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            filter: brightness(0.95);
        }
        .profit-status-button.active {
            color: white;
            border-color: #2b6cb0;
            box-shadow: 0 2px 5px rgba(49, 130, 206, 0.2);
            background-color: #3182ce !important;
        }

        /* Business model filter buttons styles */
        .business-model-button {
            margin: 0 0 6px 0;
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: block;
            width: 100%;
            text-align: center;
        }
        .business-model-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            filter: brightness(0.95);
        }
        .business-model-button.active {
            color: white;
            border-color: #2b6cb0;
            box-shadow: 0 2px 5px rgba(49, 130, 206, 0.2);
            background-color: #3182ce !important;
        }


        /* Filters row and columns styles */
        .filters-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            gap: 10px;
        }

        .filters-column {
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 10px;
            flex: 1;
            min-width: 200px;
        }

        @media (max-width: 1200px) {
            .filters-row {
                flex-wrap: wrap;
            }

            .filters-column {
                flex-basis: calc(50% - 10px);
                min-width: 200px;
            }
        }

        @media (max-width: 768px) {
            .filters-row {
                flex-direction: column;
            }

            .filters-column {
                width: 100%;
            }
        }

        /* APC slider styles */
        #apcSliderContainer {
            padding: 0;
            background-color: transparent;
            border-radius: 0;
            border: none;
            box-shadow: none;
            margin: 0 auto;
            width: 100%;
        }

        #apcSlider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            outline: none;
            margin: 10px 0;
            width: 100%;
        }

        .apc-value-label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #4a5568;
            text-align: center;
        }

        #apcHistogram {
            height: 40px;
            margin-bottom: 5px;
            position: relative;
        }

        .apc-range-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 12px;
            color: #718096;
        }

        #apcSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3182ce;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #apcSlider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3182ce;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        #apcSlider::-webkit-slider-thumb:hover {
            background: #2c5282;
            transform: scale(1.1);
        }

        #apcSlider::-moz-range-thumb:hover {
            background: #2c5282;
            transform: scale(1.1);
        }

        /* Footer styles */
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
        }

        .footer p {
            color: #4a5568;
            font-size: 0.95rem;
        }

        .footer strong {
            color: #2d3748;
            font-weight: 600;
            margin-right: 10px;
        }

        .legend-item {
            display: inline-block;
            margin: 0 10px;
            padding: 5px 10px;
            background-color: #f8fafc;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .legend-item {
                margin: 0 5px;
                padding: 4px 8px;
                font-size: 0.85rem;
                display: inline-block;
            }
        }

        @media (max-width: 480px) {
            .legend-item {
                margin: 5px 3px;
                padding: 3px 6px;
                font-size: 0.8rem;
                display: inline-block;
            }

            .footer p {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
            }

            .footer strong {
                width: 100%;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 style="margin-bottom: 10px; margin-top: 0">Where to publish? To review?</h1>
    <p style="margin-bottom: 10px">A database of for-profit and non-profit scientific journals.</p>
    <div id="dataSourceFilters" style="margin-bottom: 10px; text-align: center;">
        <button id="allJournals" class="data-source-button active">All Journals</button>
        <button id="ecologyEvolution" class="data-source-button">Ecology & Evolution</button>
        <button id="neurosciences" class="data-source-button">Neurosciences</button>
    </div>
    <div style="position: relative; margin-bottom: 30px;">
        <div style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 80px; height: 3px; background: linear-gradient(90deg, #3182ce, #63b3ed); border-radius: 3px;"></div>
    </div>

    <div class="filters-row">
        <div class="filters-column">
            <div id="profitStatusFilters" style="text-align: center;">
                <button id="allPublishers" class="profit-status-button active">All Publishers</button>
                <button id="forProfitPublishers" class="profit-status-button" style="background-color: #ffebee;">For-profit</button>
                <button id="nonProfitPublishers" class="profit-status-button" style="background-color: #e8f5e9;">Non-profit</button>
                <button id="universityPressPublishers" class="profit-status-button" style="background-color: #fffde7;">University Press</button>
            </div>
        </div>

        <div class="filters-column">
            <div id="businessModelFilters" style="text-align: center;">
                <button id="allBusinessModels" class="business-model-button active">All Business Models</button>
                <button id="diamondOABusinessModel" class="business-model-button" style="background-color: #e3f2fd;">Diamond OA</button>
                <button id="oaBusinessModel" class="business-model-button" style="background-color: #e8eaf6;">OA</button>
                <button id="hybridBusinessModel" class="business-model-button" style="background-color: #f3e5f5;">Hybrid</button>
                <button id="subscriptionBusinessModel" class="business-model-button" style="background-color: #fce4ec;">Subscription</button>
            </div>
        </div>

        <div class="filters-column">
            <div id="apcSliderContainer" style="text-align: center; margin: 0 auto;">
                <p class="apc-value-label"><span id="apcValue">All</span></p>
                <div id="apcHistogram"></div>
                <input type="range" id="apcSlider" min="0" max="10000" value="10000">
                <div class="apc-range-labels">
                    <span>0 €</span>
                    <span>10,000 €</span>
                </div>
            </div>
        </div>

        <div class="filters-column">
            <div id="domainFilters" style="text-align: center;">
                <!-- Domain filter buttons will be added here by JavaScript -->
            </div>
        </div>
    </div>

    <div style="position: relative; margin-bottom: 30px;">
        <div style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 80px; height: 3px; background: linear-gradient(90deg, #3182ce, #63b3ed); border-radius: 3px;"></div>
    </div>

    <table id="journalTable" class="display" style="width:100%; margin-top: 0;">
        <thead>
            <tr>
                <!-- Headers will be populated by JavaScript -->
            </tr>
        </thead>
        <tbody>
            <!-- Data will be populated by DataTables -->
        </tbody>
    </table>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script>

function formatDomainName(domain) {
    // Capitalize the first letter of each word in the domain name
    return domain.replace(/_/g, ' ').split(' ').map(word =>word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
}

function parseCSV(csvText) {
    const lines = csvText.split('\n');
    const data = [];
    const domains = new Set();

    // Extract headers from the first line of the CSV
    // Line 0: "Journal","Field","Publisher","Publisher type","Business model","Institution","Institution type","Website","APC €uros","Scimago Rank","PCI partner"
    if (lines.length < 1) {
        console.error("CSV does not have header line.");
        return { data: [], domains: [] };
    }

    const rawHeaders = lines[0].split(',').map(header => {
        // Remove quotes if present
        return header.replace(/^"|"$/g, '').trim();
    });

    // Define the columns we want to display
    const finalHeadersText = [
        "Journal",
        "Field", // This will be our domain column
        "Publisher",
        "Publisher type", // This is equivalent to the old "Statut"
        "Business model", // New column
        "APC (€)", // New column
    ];

    const headerRow = $('#journalTable thead tr');
    headerRow.empty(); // Clear existing/placeholder headers
    finalHeadersText.forEach(headerText => {
        // Capitalize and replace underscores with spaces
        headerRow.append($('<th>').text(formatDomainName(headerText)));
    });

    // Find the indices of the columns we need
    const journalIndex = rawHeaders.findIndex(h => h.includes("Journal"));
    const fieldIndex = rawHeaders.findIndex(h => h.includes("Field"));
    const publisherIndex = rawHeaders.findIndex(h => h.includes("Publisher") && !h.includes("type"));
    const publisherTypeIndex = rawHeaders.findIndex(h => h.includes("Publisher type"));
    const businessModelIndex = rawHeaders.findIndex(h => h.includes("Business model"));
    const apcIndex = rawHeaders.findIndex(h => h.includes("APC"));
    const institutionIndex = rawHeaders.findIndex(h => h.includes("Institution") && !h.includes("type"));
    const institutionTypeIndex = rawHeaders.findIndex(h => h.includes("Institution type"));
    const websiteIndex = rawHeaders.findIndex(h => h.includes("Website"));
    const scimagoRankIndex = rawHeaders.findIndex(h => h.includes("Scimago"));
    const pciPartnerIndex = rawHeaders.findIndex(h => h.includes("PCI"));

    // Process data rows (starting from the 2nd line, index 1)
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();

        // Skip empty lines
        if (line === "") {
            continue;
        }

        // Parse the CSV line
        const row = [];
        let currentField = '';
        let inQuotedField = false;

        for (let k = 0; k < line.length; k++) {
            const char = line[k];

            if (char === '"') {
                if (inQuotedField && k + 1 < line.length && line[k+1] === '"') {
                    // Handle escaped quote "" inside a quoted field
                    currentField += '"';
                    k++; // Skip the second quote of the pair
                } else {
                    inQuotedField = !inQuotedField;
                }
            } else if (char === ',' && !inQuotedField) {
                row.push(currentField.trim());
                currentField = '';
            } else {
                currentField += char;
            }
        }
        row.push(currentField.trim()); // Add the last field

        // Clean up the row data by removing quotes
        const cleanRow = row.map(field => field.replace(/^"|"$/g, '').trim());

        // If we have a valid row with a journal name
        if (cleanRow.length > 0 && cleanRow[journalIndex] !== "") {
            // Extract the domain/field and add it to our set of domains
            if (cleanRow[fieldIndex]) {
                domains.add(cleanRow[fieldIndex]);
            }

            // Create a new row with the columns we want to display
            const newRow = [
                cleanRow[journalIndex] || "", // Journal
                formatDomainName(cleanRow[fieldIndex]) || "", // Field/Domain
                cleanRow[publisherIndex] || "", // Publisher
                cleanRow[publisherTypeIndex] || "", // Publisher type (status)
                formatDomainName(cleanRow[businessModelIndex]) || "", // Business model
                cleanRow[apcIndex] || "", // APC cost
                "", // Country (not available in DAFNEE.csv)
                cleanRow[institutionIndex] || "", // Institution
                cleanRow[institutionTypeIndex] || "", // Institution type
                cleanRow[websiteIndex] || "", // Website
                cleanRow[scimagoRankIndex] || "", // Scimago Rank
                cleanRow[pciPartnerIndex] || "" // PCI partner
            ];

            data.push(newRow);
        }
    }

    return {
        data: data,
        domains: Array.from(domains).sort()
    };
}

// Function to merge data from multiple CSV files and remove duplicates
function mergeData(dataArrays) {
    const mergedData = [];
    const journalSet = new Set(); // To track journal names we've already added
    const allDomains = new Set();

    // Process each data array
    dataArrays.forEach(dataObj => {
        // Add domains to the combined set
        dataObj.domains.forEach(domain => allDomains.add(domain));

        // Process each row of data
        dataObj.data.forEach(row => {
            const journalName = row[0]; // Journal name is at index 0

            // If we haven't seen this journal before, add it to the merged data
            if (!journalSet.has(journalName)) {
                journalSet.add(journalName);
                mergedData.push(row);
            }
        });
    });

    return {
        data: mergedData,
        domains: Array.from(allDomains).sort()
    };
}

$(document).ready(function() {
    let dataTable; // Variable to store the DataTable instance

    // Add click handler for expandable rows
    $('#journalTable').on('click', 'td.details-control', function() {
        var tr = $(this).closest('tr');
        var row = dataTable ? dataTable.row(tr) : $('#journalTable').DataTable().row(tr);

        if (row.child.isShown()) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
        } else {
            // Open this row
            var content = tr.data('child-content');
            row.child(content).show();
            tr.addClass('shown');
        }
    });

    // Add event handlers for data source buttons
    $('#allJournals').on('click', function() {
        $('.data-source-button').removeClass('active');
        $(this).addClass('active');
        loadTable('all');
    });

    $('#ecologyEvolution').on('click', function() {
        $('.data-source-button').removeClass('active');
        $(this).addClass('active');
        loadTable('ecology');
    });

    $('#neurosciences').on('click', function() {
        $('.data-source-button').removeClass('active');
        $(this).addClass('active');
        loadTable('neuro');
    });

    // Add event handlers for profit status filter buttons
    $('#allPublishers').on('click', function() {
        $('.profit-status-button').removeClass('active');
        $(this).addClass('active');
        if (dataTable) {
            dataTable.column(3).search('').draw();

            // Update histogram based on filtered data
            const filteredData = dataTable.rows({ search: 'applied' }).data().toArray();
            const distribution = calculateAPCDistribution(filteredData);
            renderHistogram(distribution);
        }
    });

    $('#forProfitPublishers').on('click', function() {
        $('.profit-status-button').removeClass('active');
        $(this).addClass('active');
        if (dataTable) {
            dataTable.column(3).search('^For-profit$', true, false).draw();

            // Update histogram based on filtered data
            const filteredData = dataTable.rows({ search: 'applied' }).data().toArray();
            const distribution = calculateAPCDistribution(filteredData);
            renderHistogram(distribution);
        }
    });

    $('#nonProfitPublishers').on('click', function() {
        $('.profit-status-button').removeClass('active');
        $(this).addClass('active');
        if (dataTable) {
            dataTable.column(3).search('^Non-profit$', true, false).draw();

            // Update histogram based on filtered data
            const filteredData = dataTable.rows({ search: 'applied' }).data().toArray();
            const distribution = calculateAPCDistribution(filteredData);
            renderHistogram(distribution);
        }
    });

    $('#universityPressPublishers').on('click', function() {
        $('.profit-status-button').removeClass('active');
        $(this).addClass('active');
        if (dataTable) {
            dataTable.column(3).search('^University Press$', true, false).draw();

            // Update histogram based on filtered data
            const filteredData = dataTable.rows({ search: 'applied' }).data().toArray();
            const distribution = calculateAPCDistribution(filteredData);
            renderHistogram(distribution);
        }
    });

    // Add event handlers for business model filter buttons
    $('#allBusinessModels').on('click', function() {
        $('.business-model-button').removeClass('active');
        $(this).addClass('active');
        if (dataTable) {
            dataTable.column(4).search('').draw();

            // Update histogram based on filtered data
            const filteredData = dataTable.rows({ search: 'applied' }).data().toArray();
            const distribution = calculateAPCDistribution(filteredData);
            renderHistogram(distribution);
        }
    });

    $('#diamondOABusinessModel').on('click', function() {
        $('.business-model-button').removeClass('active');
        $(this).addClass('active');
        if (dataTable) {
            dataTable.column(4).search('Diamond OA', false, false).draw();

            // Update histogram based on filtered data
            const filteredData = dataTable.rows({ search: 'applied' }).data().toArray();
            const distribution = calculateAPCDistribution(filteredData);
            renderHistogram(distribution);
        }
    });

    $('#oaBusinessModel').on('click', function() {
        $('.business-model-button').removeClass('active');
        $(this).addClass('active');
        if (dataTable) {
            dataTable.column(4).search('^OA$', true, false).draw();

            // Update histogram based on filtered data
            const filteredData = dataTable.rows({ search: 'applied' }).data().toArray();
            const distribution = calculateAPCDistribution(filteredData);
            renderHistogram(distribution);
        }
    });

    $('#hybridBusinessModel').on('click', function() {
        $('.business-model-button').removeClass('active');
        $(this).addClass('active');
        if (dataTable) {
            dataTable.column(4).search('^Hybrid$', true, false).draw();

            // Update histogram based on filtered data
            const filteredData = dataTable.rows({ search: 'applied' }).data().toArray();
            const distribution = calculateAPCDistribution(filteredData);
            renderHistogram(distribution);
        }
    });

    $('#subscriptionBusinessModel').on('click', function() {
        $('.business-model-button').removeClass('active');
        $(this).addClass('active');
        if (dataTable) {
            dataTable.column(4).search('^Subscription$', true, false).draw();

            // Update histogram based on filtered data
            const filteredData = dataTable.rows({ search: 'applied' }).data().toArray();
            const distribution = calculateAPCDistribution(filteredData);
            renderHistogram(distribution);
        }
    });

    // Function to calculate APC distribution
    function calculateAPCDistribution(data) {
        // Define bins for APC costs (0-1000, 1001-2000, etc.)
        const bins = [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000];
        const distribution = Array(bins.length - 1).fill(0);

        // Count journals in each bin
        data.forEach(row => {
            const apcValue = row[5].replace(/[^\d]/g, '');
            if (apcValue !== '') {
                const apc = parseInt(apcValue);
                for (let i = 0; i < bins.length - 1; i++) {
                    if (apc >= bins[i] && apc <= bins[i + 1]) {
                        distribution[i]++;
                        break;
                    }
                }
            }
        });

        return { bins, distribution };
    }

    // Function to render the histogram
    function renderHistogram(distribution, maxCount) {
        const histogramContainer = $('#apcHistogram');
        histogramContainer.empty();

        const { bins, distribution: counts } = distribution;
        const containerWidth = histogramContainer.width();
        const barWidth = containerWidth / (bins.length - 1);

        // Find the maximum count for scaling
        const maxValue = maxCount || Math.max(...counts, 1);

        // Create bars for each bin
        for (let i = 0; i < counts.length; i++) {
            const height = (counts[i] / maxValue) * 100;
            const bar = $('<div>')
                .css({
                    position: 'absolute',
                    left: (i * barWidth) + 'px',
                    bottom: '0',
                    width: (barWidth - 2) + 'px',
                    height: height + '%',
                    backgroundColor: '#3182ce',
                    borderRadius: '2px 2px 0 0',
                    opacity: '0.7'
                })
                .attr('title', counts[i] + ' journals with APC between ' + bins[i] + '€ and ' + bins[i+1] + '€');

            // Add count label on top of the bar
            const label = $('<div>')
                .text(counts[i])
                .css({
                    position: 'absolute',
                    top: '-18px',
                    width: '100%',
                    textAlign: 'center',
                    fontSize: '10px',
                    color: '#4a5568'
                });

            if (counts[i] > 0) {
                bar.append(label);
            }

            histogramContainer.append(bar);
        }
    }

    // Add event handler for APC slider
    $('#apcSlider').on('input', function() {
        const maxAPC = $(this).val();
        $('#apcValue').text(maxAPC === '10000' ? 'All' : '≤ ' + maxAPC + ' €');

        if (dataTable) {
            // Custom filtering function for APC column
            $.fn.dataTable.ext.search.push(
                function(settings, data, dataIndex) {
                    if (maxAPC === '10000') return true; // Show all if slider is at max

                    const apcValue = data[5].replace(/[^\d]/g, ''); // Extract numeric value from APC column
                    if (apcValue === '') return true; // Show entries with no APC value

                    return parseInt(apcValue) <= parseInt(maxAPC);
                }
            );

            dataTable.draw();

            // Update histogram based on filtered data
            const filteredData = dataTable.rows({ search: 'applied' }).data().toArray();
            const distribution = calculateAPCDistribution(filteredData);
            renderHistogram(distribution);

            // Remove the custom filter after drawing to avoid stacking multiple filters
            $.fn.dataTable.ext.search.pop();
        }
    });

    // Function to fetch CSV files based on the selected data source
    async function fetchCSVFiles(dataSource = 'all') {
        try {
            let csvFiles = [];

            // Determine which CSV files to load based on the data source
            if (dataSource === 'all') {
                csvFiles = ['data/DAFNEE.csv', 'data/data.csv']; // All journals
            } else if (dataSource === 'ecology') {
                csvFiles = ['data/DAFNEE.csv']; // Ecology & Evolution
            } else if (dataSource === 'neuro') {
                csvFiles = ['data/data.csv']; // Neurosciences
            }

            // Fetch and parse the selected CSV files
            const dataPromises = csvFiles.map(async (file) => {
                try {
                    const response = await fetch(file);
                    if (!response.ok) {
                        console.error(`Failed to fetch ${file}: ${response.statusText}`);
                        return { data: [], domains: [] };
                    }
                    const csvText = await response.text();
                    return parseCSV(csvText);
                } catch (error) {
                    console.error(`Error processing ${file}:`, error);
                    return { data: [], domains: [] };
                }
            });

            // Wait for all files to be fetched and parsed
            const allData = await Promise.all(dataPromises);

            // If only one file is loaded, return its data directly
            if (csvFiles.length === 1) {
                return allData[0];
            }

            // Otherwise, merge the data from all files
            return mergeData(allData);
        } catch (error) {
            console.error('Error fetching CSV files:', error);
            return { data: [], domains: [] };
        }
    }

    // Function to load and initialize the table with data from the selected source
    async function loadTable(dataSource = 'all') {
        try {
            // Clear existing table if it exists
            if (dataTable) {
                dataTable.destroy();
                $('#domainFilters').empty();
            }

            // Reset profit status filters
            $('.profit-status-button').removeClass('active');
            $('#allPublishers').addClass('active');

            // Reset business model filters
            $('.business-model-button').removeClass('active');
            $('#allBusinessModels').addClass('active');

            // Reset APC slider
            $('#apcSlider').val(10000);
            $('#apcValue').text('All');

            // Show loading indicator
            $('#journalTable').parent().append('<p id="loading-indicator">Loading data...</p>');

            // Fetch data from the selected source
            const { data: tableData, domains } = await fetchCSVFiles(dataSource);

            // Remove loading indicator
            $('#loading-indicator').remove();

            if (tableData && tableData.length > 0) {
                dataTable = $('#journalTable').DataTable({
                    data: tableData,
                    scrollX: false, // Disable horizontal scrolling to allow responsive wrapping
                    paging: false, // Disable pagination to show all items
                    searching: true,
                    ordering: true,
                    info: true,
                    dom: 'ift', // i=info, f=filtering, t=table (places info above table)
                    responsive: {
                        details: {
                            display: $.fn.dataTable.Responsive.display.childRow
                        },
                        breakpoints: [
                            { name: 'desktop', width: Infinity },
                            { name: 'tablet',  width: 1024 },
                            { name: 'phone',   width: 480 }
                        ]
                    },
                    columnDefs: [
                        // Format the publisher type column (3)
                        {
                            targets: [3],
                            render: function(data, type, row) {
                                if (type === 'display' || type === 'filter') {
                                    if (data === 'For-profit') return 'For-profit';
                                    if (data === 'Non-profit') return 'Non-profit';
                                    if (data === 'University Press') return 'University Press';
                                    return data;
                                }
                                return data;
                            }
                        },
                        // Make the first column (Journal) expandable to show details
                        {
                            targets: 0,
                            className: 'details-control'
                        }
                    ],
                    language: {
                        info: "Displaying all _TOTAL_ journals",
                        infoEmpty: "No journals available",
                        emptyTable: "No journal data available",
                        search: ""
                    },
                    initComplete: function() {
                        var table = this.api();
                        var domainFiltersContainer = $('#domainFilters');

                        // Add placeholder to search input
                        $('.dataTables_filter input').attr('placeholder', 'Search journals...');

                        // Add event handler for search box
                        $('.dataTables_filter input').on('keyup', function() {
                            // Update histogram based on filtered data
                            const filteredData = table.rows({ search: 'applied' }).data().toArray();
                            const distribution = calculateAPCDistribution(filteredData);
                            renderHistogram(distribution);
                        });

                        // Initialize the APC histogram
                        const allData = table.rows().data().toArray();
                        const distribution = calculateAPCDistribution(allData);
                        renderHistogram(distribution);

                        // Add "Show All" button
                        var showAllButton = $('<button class="domain-filter-button">SHOW ALL</button>')
                            .on('click', function() {
                                // Clear search for the Field column (1)
                                table.column(1).search('');
                                table.draw();
                                domainFiltersContainer.find('.domain-filter-button').removeClass('active');
                                $(this).addClass('active');

                                // Update histogram based on filtered data
                                const filteredData = table.rows({ search: 'applied' }).data().toArray();
                                const distribution = calculateAPCDistribution(filteredData);
                                renderHistogram(distribution);
                            });
                        domainFiltersContainer.append(showAllButton);

                        // Add domain-specific filter buttons using the dynamically extracted domains
                        domains.forEach(function(domainName) {
                            var formattedDomainName = formatDomainName(domainName);
                            var button = $('<button class="domain-filter-button">' + formattedDomainName + '</button>')
                                .on('click', function() {
                                    var isActive = $(this).hasClass('active');

                                    // Clear search for the Field column
                                    table.column(1).search('');
                                    domainFiltersContainer.find('.domain-filter-button').removeClass('active');

                                    if (isActive) {
                                        // If button was active, clicking again means show all
                                        showAllButton.addClass('active');
                                    } else {
                                        // If button was not active, make it active and apply its filter
                                        table.column(1).search('^' + formattedDomainName + '$', true, false); // Exact match for the domain
                                        $(this).addClass('active');
                                    }
                                    table.draw();

                                    // Update histogram based on filtered data
                                    const filteredData = table.rows({ search: 'applied' }).data().toArray();
                                    const distribution = calculateAPCDistribution(filteredData);
                                    renderHistogram(distribution);
                                });
                            domainFiltersContainer.append(button);
                        });

                        // Set "Show All" as active by default
                        showAllButton.addClass('active');
                    },

                    // Add child row display functionality for journal details
                    rowCallback: function(row, data, index) {
                        // Apply row coloring based on publisher type (column 3)
                        var publisherType = data[3]; // Get the publisher type value
                        if (publisherType === 'For-profit') {
                            $(row).addClass('for-profit-row');
                        } else if (publisherType === 'Non-profit') {
                            $(row).addClass('non-profit-row');
                        } else if (publisherType === 'University Press') {
                            $(row).addClass('university-press-row');
                        }

                        // Create journal details HTML
                        var journalDetails = '<div class="domain-details"><ul>';

                        // Add institution
                        if (data[7]) {
                            journalDetails += '<li><span class="domain-name">INSTITUTION:</span> <span>' + data[7] + '</span></li>';
                        }

                        // Add institution type
                        if (data[8]) {
                            journalDetails += '<li><span class="domain-name">INSTITUTION TYPE:</span> <span>' + data[8] + '</span></li>';
                        }

                        // Add website with link
                        if (data[9]) {
                            journalDetails += '<li><span class="domain-name">WEBSITE:</span> <a href="' + data[9] + '" target="_blank">' + data[9] + '</a></li>';
                        }

                        // Add Scimago Rank
                        if (data[10]) {
                            journalDetails += '<li><span class="domain-name">SCIMAGO RANK:</span> <span>' + data[10] + '</span></li>';
                        }

                        // Add PCI partner
                        if (data[11]) {
                            journalDetails += '<li><span class="domain-name">PCI PARTNER:</span> <span>' + data[11] + '</span></li>';
                        }

                        journalDetails += '</ul></div>';

                        // Store the journal details in the row's data
                        $(row).data('child-content', journalDetails);
                    }
                });
            } else if (tableData) { // tableData is an empty array
                $('#journalTable').parent().append('<p>No data found in CSV after parsing headers.</p>');
            }
        } catch (error) {
            console.error('Error loading or processing CSV files:', error);
            $('#journalTable').parent().append('<p style="color:red;">Could not load data. Please ensure CSV files exist in the data folder and check the browser console for errors.</p>');
        }
    }

    // Load the table with all journals by default
    loadTable('all');
});
</script>


</body>
</html>
